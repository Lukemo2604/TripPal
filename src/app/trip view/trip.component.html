<div *ngIf="showPopup" class="popup-message">
  {{ popupMessage }}
</div>

<div class="trip-container" *ngIf="editTrip">
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Trip: {{ editTrip.location }}</h2>
    <label>Location:
      <input #locInput [(ngModel)]="editTrip.location" name="location" placeholder="Where to?" />
    </label>
    <label>Start Date:
      <input [(ngModel)]="editTrip.startDate" type="date" name="startDate" />
    </label>
    <label>End Date:
      <input [(ngModel)]="editTrip.endDate" type="date" name="endDate" />
    </label>

    <!-- Flights mini form -->
    <button class="primary-btn" (click)="toggleFlights()">
      {{ expandFlights ? 'Flight Details' : 'Show Flights' }}
    </button>
    <div *ngIf="expandFlights && editTrip?.flights as flights" class="flight-container">
      <h4>Flights</h4>
      <div class="flight-columns">
        <!-- Departing Flight Column -->
        <div class="flight-section">
          <h5>Departing Flight</h5>
          <label>Flight Number:
            <input type="text" [(ngModel)]="flights.departing.flightNumber" name="departingFlightNumber" required />
          </label>
          <div class="flight-row">
            <label>Departure Time:
              <input type="time" [(ngModel)]="flights.departing.departureTime" name="departingDepartureTime" required />
            </label>
            <label>Arrival Time:
              <input type="time" [(ngModel)]="flights.departing.arrivalTime" name="departingArrivalTime" required />
            </label>
          </div>
        </div>
        <!-- Arriving Flight Column -->
        <div class="flight-section">
          <h5>Arriving Flight</h5>
          <label>Flight Number:
            <input type="text" [(ngModel)]="flights.arriving.flightNumber" name="arrivingFlightNumber" required />
          </label>
          <div class="flight-row">
            <label>Departure Time:
              <input type="time" [(ngModel)]="flights.arriving.departureTime" name="arrivingDepartureTime" required />
            </label>
            <label>Arrival Time:
              <input type="time" [(ngModel)]="flights.arriving.arrivalTime" name="arrivingArrivalTime" required />
            </label>
          </div>
        </div>
      </div>
    </div>

    <label>Accommodation:
      <input #accomInput [(ngModel)]="editTrip.accommodation" name="accommodation" placeholder="Hotel name?" />
    </label>
    <label>Budget:
      <input [(ngModel)]="editTrip.budget" type="number" name="budget" />
    </label>
    <label>Notes:
      <textarea [(ngModel)]="editTrip.notes" name="notes"></textarea>
    </label>

    <!-- FamilyAttending array -->
    <h4>Family Attending</h4>
    <div *ngIf="editTrip.familyAttending?.length; else noFam">
      <ul class="family-list">
        <li *ngFor="let fam of editTrip.familyAttending">
          <label>
            <input type="checkbox" [(ngModel)]="fam.attending" name="fam{{fam.name}}" />
            <span class="fam-name">{{ fam.name }}</span>
          </label>
        </li>
      </ul>
    </div>
    <ng-template #noFam>
      <p>No family members listed.</p>
    </ng-template>

    <button class="primary-btn" (click)="saveTrip()">Save</button>
    <button class="danger-btn" (click)="deleteTrip()">Delete Trip</button>
  </div>

  <!-- Map + multi-day itinerary area -->
  <div class="map-area">
    <google-map
      [center]="mapCenter"
      [zoom]="zoom"
      [options]="mapOptions"
      (mapClick)="onMapClicked($event)"
      height="600px"
      width="600px"
    >
    </google-map>

    <!-- Itinerary split by day -->
    <div class="itinerary">
      <h4>Itinerary</h4>
      <div *ngFor="let d of days" class="day-card">
        <div class="day-header" (click)="toggleDay(d.dayIndex)">
          <h5>Day {{ d.dayIndex }} ({{ d.date }})</h5>
          <span class="toggle-indicator">
            {{ isDayExpanded(d.dayIndex) ? '-' : '+' }}
          </span>
        </div>
        <div class="day-content" *ngIf="isDayExpanded(d.dayIndex)">
          <!-- List items for this day -->
          <ul>
            <li class="itinerary-item" *ngFor="let item of getItineraryItemsForDay(d.dayIndex)">
              <label>
                <span>Place:</span>
                <input [(ngModel)]="item.placeName" name="placeName{{item.dayIndex}}" type="text" />
              </label>
              <label>
                <span>Start:</span>
                <input [(ngModel)]="item.startTime" name="startTime{{item.dayIndex}}" type="time" />
              </label>
              <label>
                <span>End:</span>
                <input [(ngModel)]="item.endTime" name="endTime{{item.dayIndex}}" type="time" />
              </label>
              <label>
                <span>Cost:</span>
                <input [(ngModel)]="item.cost" name="cost{{item.dayIndex}}" type="number" />
              </label>
              <button class="danger-btn" (click)="removeItineraryItem(editTrip!.itinerary.indexOf(item))">
                Remove
              </button>
            </li>
          </ul>
          <!-- Add Custom Activity form for this day -->
          <div class="add-activity-form">
            <h5>Add Custom Activity (Day {{ d.dayIndex }})</h5>
            <label>
              Place Name:
              <input [(ngModel)]="newActivityForDay[d.dayIndex].placeName" name="newActivityPlaceDay{{ d.dayIndex }}" type="text" />
            </label>
            <div class="time-cost-row">
              <label>
                Start:
                <input [(ngModel)]="newActivityForDay[d.dayIndex].startTime" type="time" name="newActivityStartDay{{ d.dayIndex }}" />
              </label>
              <label>
                End:
                <input [(ngModel)]="newActivityForDay[d.dayIndex].endTime" type="time" name="newActivityEndDay{{ d.dayIndex }}" />
              </label>
              <label>
                Cost:
                <input [(ngModel)]="newActivityForDay[d.dayIndex].cost" type="number" name="newActivityCostDay{{ d.dayIndex }}" />
              </label>
            </div>
            <button class="primary-btn" (click)="addCustomActivity(d.dayIndex)">
              Add Activity
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<support></support>
